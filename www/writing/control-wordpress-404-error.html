<!DOCTYPE html><html><head><meta charset="utf8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>Control WordPress 404 Error</title><meta name="description" content="Welling Guzman is a software engineer, and this is his writing in third person."><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="author" content="undefined"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1"></head><body class="writing"><header id="header"><div class="Content-wrapper"><div class="sitebar"><a href="/" class="site-title"><span class="first">welling</span><span class="last">guzman</span></a><nav id="site-nav"><ul class="nav-links"><li><a href="/">home</a></li><li><a href="/writing">writing</a></li><li><a href="/about">about</a></li></ul></nav></div></div></header><div class="Heading"><div class="Content-wrapper"><h1 class="Header-title">Control WordPress 404 Error</h1><h4 class="Header-caption"><span class="Timestamp">January 21, 2014</span></h4></div></div><div class="Content"><div class="Content-wrapper"><article class="Article"><div class="Article-content"><p>I have site built with Wordpress and I wanted to catch all 404 page that Wordpress try to display and make my own custom 404 page depending on the requested page, or in fact I just wanted to whether or not show a 404 page.</p>

<!-- more -->

<p>If the user, let&#39;s say, go to <code><a href="http://mysite.com/someword">http://mysite.com/someword</a></code> on mysite, and if that is not a post/page it would probably display a 404 page, but I didn&#39;t want that behavior I wanted to search if <code>someword</code> is a category slug or a tag and display posts in that category or tag, otherwise would show the normal 404 page.</p>

<p>So, this is what I did, I added a action to <code>template_redirect</code> hook, that is executed before WordPress determine which page is going to be loaded.</p>

<pre class="php"><code>
add_action('template_redirect', '_custom_redirect');
function _custom_redirect()
{
  global $wp_query;

  if ( $wp_query->is_404() )
  {
    // Here I take over 404 page
  }
}
</code></pre>

<p>So now, I know when it&#39;s a 404 page, I need to get the string it was passed on the url, in this case <code>someword</code>, so I can check if the string match a category or a tag name with that name.</p>

<p>This string is stored in a array named <code>query_vars</code> with the key <code>name</code>. <code>query_vars</code> is a variable member of <code>WP_Query</code> which WordPress uses to execute the main query.</p>

<p><pre class="php"><code>
add_action(&#39;template_redirect&#39;, &#39;_custom_redirect&#39;);
function _custom_redirect()
{
  global $wp_query;

  if ( $wp_query-&gt;is_404() )
  {
    $page_name = $wp_query-&gt;query_vars[&#39;name&#39;];

    if ( ! $page_name )
      return;

    if ( ($category =  get_category_by_slug( $page_name )) )
    {
      // Here it found a category
    }
    elseif ( ($tag = get_term_by(&#39;slug&#39;, $page_name, &#39;post_tag&#39;) ) )
    {
      // Here it found a tag
    }
    else
    {
      // Is not a category or a tag
      return;
    }
  }
}
</code></pre></p>

<p>After this code WordPress would still &quot;believe&quot; it&#39;s a 404 page, I needed to add some more lines to changed this.</p>

<p><pre class="php"><code>
add_action(&#39;template_redirect&#39;, &#39;_custom_redirect&#39;);
function _custom_redirect()
{
  global $wp_query;

  if ( $wp_query-&gt;is_404() )
  {
    $page_name = $wp_query-&gt;query_vars[&#39;name&#39;];

    if ( ! $page_name )
      return;

    if ( ($category =  get_category_by_slug( $page_name )) )
    {
      // Here it found a category
      $wp_query-&gt;is_category = true;
    }
    elseif ( ($tag = get_term_by(&#39;slug&#39;, $page_name, &#39;post_tag&#39;) ) )
    {
      // Here it found a tag
      $wp_query-&gt;is_tag = true;
    }
    else
    {
      // Is not a category or a tag
      return;
    }

    $wp_query-&gt;is_404 = false;
    status_header( 200 );
  }
}
</code></pre></p>

<p>This is pretty much what I wanted to do, now I can get a <em>tag</em> or a <em>category</em> object if one exists, otherwise WordPress will keep its own process and will display its normal 404 page.</p>

<p>If I actually got a tag or category object, I need to query all posts under it.</p>

<p><pre class="php"><code>
add_action(&#39;template_redirect&#39;, &#39;_custom_redirect&#39;);
function _custom_redirect()
{
  global $wp_query;

  if ( $wp_query-&gt;is_404() )
  {
    $page_name = $wp_query-&gt;query_vars[&#39;name&#39;];

    if ( ! $page_name )
      return;

    $query_args = &#39;&#39;;
    if ( ($category =  get_category_by_slug( $page_name )) )
    {
      // Here we found a category
      $wp_query-&gt;is_category = true;
      $query_args = &#39;category_name=&#39; . $category-&gt;slug;
    }
    elseif ( ($tag = get_term_by(&#39;slug&#39;, $page_name, &#39;post_tag&#39;) ) )
    {
      // Here we found a tag
      $wp_query-&gt;is_tag = true;
      $query_args = &#39;tag=&#39; . $tag-&gt;slug;
    }
    else
    {
      // Is not a category or a tag
      return;
    }

    $wp_query-&gt;is_404 = false;
    $wp_query-&gt;is_archive = true;
    status_header( 200 );

    query_posts( $query_args );
  }
}
</code></pre></p>

<p>If <code>status_header( 200 );</code> isn&#39;t added the HTTP status will always be a 404, so this line change the status code from 404 to 200.</p>

<p>This is about it, but I want a little bit more, I want if <code>is_category();</code> or <code>is_tag();</code> functions are used, it has to return true. In order to make this to happen I needed to set a couple of variables more.</p>

<p><pre class="php"><code>
$wp_query-&gt;set(&#39;category_name&#39;, $category-&gt;slug);
$wp_query-&gt;set(&#39;cat&#39;, $category-&gt;term_id);

$wp_query-&gt;set(&#39;tag&#39;, $tag-&gt;slug);
$wp_query-&gt;set(&#39;tag_id&#39;, $tag-&gt;term_id);
</code></pre></p>

<p><code>$wp_query-&gt;set()</code> will set a variable to <code>query_vars</code> array, which as I mentioned before is used by WordPress main query. With this variables set, when WordPress executes <code>is_category();</code> or <code>is_tag();</code> would have category or tag specific variable values to check if is a category/tag or not. </p>

<h3>Final code</h3>

<p><pre class="php"><code>
add_action(&#39;template_redirect&#39;, &#39;_custom_redirect&#39;);
function _custom_redirect()
{
  global $wp_query;

  if ( $wp_query-&gt;is_404() )
  {
    $page_name = $wp_query-&gt;query_vars[&#39;name&#39;];

    if ( ! $page_name )
      return;

    $query_args = &#39;&#39;;
    if ( ($category =  get_category_by_slug( $page_name )) )
    {
      // Here we found a category
      $wp_query-&gt;is_category = true;
      $wp_query-&gt;set(&#39;category_name&#39;, $category-&gt;slug);
      $wp_query-&gt;set(&#39;cat&#39;, $category-&gt;term_id);

      $query_args = &#39;category_name=&#39; . $category-&gt;slug;
    }
    elseif ( ($tag = get_term_by(&#39;slug&#39;, $page_name, &#39;post_tag&#39;) ) )
    {
      // Here we found a tag
      $wp_query-&gt;is_tag = true;
      $wp_query-&gt;set(&#39;tag&#39;, $tag-&gt;slug);
      $wp_query-&gt;set(&#39;tag_id&#39;, $tag-&gt;term_id);

      $query_args = &#39;tag=&#39; . $tag-&gt;slug;
    }
    else
    {
      // Is not a category or a tag
      return;
    }

    $wp_query-&gt;is_404 = false;
    $wp_query-&gt;is_archive = true;
    status_header( 200 );

    query_posts( $query_args );
  }
}
</code></pre></p>

<p>This would be helpful too if you want to log/register/email requested pages that ends up being a 404 page.</p>

<p><strong>NOTE:</strong> if you don&#39;t have any category or tag template page will returns a 404 page template, just take that in mind.</p><div class="Article-signature">—<a href="http://twitter.com/WellingGuzman">@WellingGuzman</a></div></div><div class="Article-footer"></div></article></div></div><footer id="footer"><div class="Content-wrapper"><div class="Site-footer-links"><a href="/about">About</a>•<a target="_blank" href="https://twitter.com/WellingGuzman">Twitter</a>•<a target="_blank" href="https://github.com/WellingGuzman">GitHub</a></div><div class="copyright">Copyright &copy; 2013&nbsp;<a href="https://plus.google.com/109985810023249441310/posts" rel="publisher">Welling Guzman</a></div></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-37732822-1', 'auto');
ga('send', 'pageview');</script></body></html>