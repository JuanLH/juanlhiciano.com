<!DOCTYPE html><html><head><meta charset="utf8"><title>MySQL string columns key length</title><meta name="description" content="Notes about code and among other things."><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="author" content="undefined"><link href="https://plus.google.com/109985810023249441310/posts" rel="publisher"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.3"><script>var SITE_VERSION = '1.3';</script></head><body class="fresh-outfit notes"><div id="sitebar"><div class="container"><section><nav class="menu"><ul class="nav-links"><li><a href="/">home</a></li><li class="selected"><a href="/notes">notes</a></li><li><a href="/about">about</a></li><li><a href="/experiments">lab</a></li><li><a href="/projects">projects</a></li></ul></nav></section></div></div><hr><main><div class="container"><section><article class="Post"><h1 class="Post-title">MySQL string columns key length</h1><div class="Post-meta"><span class="Timestamp">Sunday, May 28th, 2017</span><div class="Tags"><a href="/tags/mysql" class="Tag">mysql</a><a href="/tags/unicode" class="Tag">unicode</a></div></div><p>After changing the default charset from <code>utf8</code> to <code>utf8mb4</code> to support emojis on <a href="https://getdirectus.com">Directus</a>, we started to received errors that the key was too long.</p>
<p>How can be too long if we only change the charset? one may ask.</p>
<p>First these are the errors I&#39;m talking about:</p>
<pre><code>#1071 - Specified key was too long; max key length is 767 bytes
#1071 - Specified key was too long; max key length is 1000 bytes
#1071 - Specified key was too long; max key length is 3072 bytes
</code></pre><p>It can be any of those errors depending on whether the table&#39;s storage engine is: MySIAM, InnoDb or InnoDb with <code>innodb_large_prefix</code> enabled.</p>
<h2>TL;DR</h2><p>utf8 charset requires only 3 bytes per character, while utf8mb4 requires 4 bytes, which mean you have to use at most 191 characters in your string column</p>
<p>191 characters x 4 bytes = 754 bytes which is less than the maximum length of 767 bytes;</p>
<hr>
<h2>String storage</h2><p>String storage size vary depends on if the column is fixed-length or variable-length, it also depends on the charset it takes more bytes to storage a japanese character than an ASCII/Latin letter.</p>
<p>As an example <code>CHAR</code> is a fixed-length while <code>VARCHAR</code> and <code>TEXT</code> are variable-length.</p>
<p>All fixed-length data types uses all the bytes declared it with, for example <code>CHAR(16)</code>, no matter what&#39;s inside, there are not truncated as <code>VARCHAR</code> will be, but right padded with spaces to the specific length.</p>
<p>In the other hand using <code>VARCHAR(16)</code> MySQL internally will remove all trailing spaces from any variable-length column data type.</p>
<p><code>VARCHAR</code> requires a prefix value of 1 byte to store the length of the string if the size is less than 256, otherwise it will uses 2 bytes.</p>
<p>One tip is not to use CHAR if you are not going to use all the characters almost all the time, because the size can pile up with empty strings column.</p>
<h2>Character Set</h2><p>The <code>UTF8</code> character set uses a maximum of 3 bytes per character and only contains Basic Multilingual Plane (BMP) characters, which is the home of 65,536 characters (16 bits) from U+0000 to U+FFFF.</p>
<p>The <code>UTF8mb4</code> character set uses a maximum of 4 bytes per character which include all of BMP characters and Supplementary Multilingual Plane (SMP) which include another possibility of 65,536 new characters from U+10000 to U+1FFFF.</p>
<h2>Emojis (Unicode characters)</h2><p><code>UTF8</code> can support emoji, but not all of them, all the new emoji are part of the SMP, so in other to support both basic and supplementary we must use <code>UTF8mb4</code>.</p>
<p>The sparkle emoji (âœ¨ U+2728) is between U+0000 and U+FFFF then it can be used on <code>utf8</code> but the Woman Health Worker (ðŸ‘© U+1F469) which is not between U+0000 and U+FFFF, must use the <code>utf8mb4</code> charset.</p>
<h2>Index length</h2><p>Now all the characters use 4 bytes instead of 3, so all columns that has more than 191 characters now uses more than 767 bytes, because 192 x 4 bytes is 768 bytes.</p>
<p>The options were removing the index, keep using <code>utf8</code> or reduce the length. Removing the index wasn&#39;t an option neither keep using the <code>utf8</code>, but reducing the length was possible was the columns will probably never met the actual length which is 255 characters, reducing it to 191 was optimal and in no way will harm the system.</p>
<h2>Conclusion</h2><p>Changing all string columns that length are greater than 191 characters to 191.</p>
<p>If changing the length is not a possible or desired option, changing the column index to only a chunk of x characters.</p>
<pre><code class="language-sql">CREATE INDEX index_name ON posts (title(191));
</code></pre></article></section></div></main><hr><footer id="footer"><div class="container"><section><ul><li><span class="copyright">Copyright &copy; 2017<a href="https://plus.google.com/109985810023249441310/posts" rel="publisher">Welling GuzmÃ¡n</a></span></li><li><a href="/about">About</a></li><li><a href="https://twitter.com/WellingGuzman">Twitter</a></li><li><a href="https://github.com/WellingGuzman">GitHub</a></li><li><a href="https://www.flickr.com/people/wellingguzman">Photos</a></li><li><a href="/feed.xml">Subscribe (RSS)</a></li></ul></section></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-37732822-1', 'auto');
ga('send', 'pageview');</script></body></html>