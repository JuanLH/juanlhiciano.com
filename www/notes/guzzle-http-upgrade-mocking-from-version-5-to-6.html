<!DOCTYPE html><html id="notes"><head><meta charset="utf8"><title>Guzzle HTTP: Upgrade mocking from version 5 to 6</title><meta name="description" content="Notes about code and among other things."><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="author" content="undefined"><link href="https://plus.google.com/109985810023249441310/posts" rel="publisher"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="/css/main.css?v=1.5"><script>var SITE_VERSION = '1.5';</script></head><body class="comfy-outfit notes"><div id="sitebar"><div class="container"><section><nav class="menu"><ul class="nav-links"><li><a href="/">home</a></li><li class="selected"><a href="/notes">notes</a></li><li><a href="/hire-me">hire me</a></li><li><a href="/about">about</a></li></ul></nav></section></div></div><hr><main><div class="container"><section><article class="Post"><h1 class="Post-title">Guzzle HTTP: Upgrade mocking from version 5 to 6</h1><div class="Post-meta"><span class="Timestamp">Saturday, March 31st, 2018</span><div class="Tags"><a href="/tags/php" class="Tag">php</a></div></div><p>Testing a http response with guzzle 5 was done using the <code>Subscriber/Mock</code> class, but on version 6, this class doesn't exists.</p>
<p>The way this mock response works is by attaching fake response objects to the http client, and on every request it will pick the result from the queue instead of making a real request to the server.</p>
<h2>Guzzle HTTP 5</h2><p>Let's take a look how mocking was done on version 5 in the example below:</p>
<pre rel="php" class="editor editor-colors"><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="punctuation section embedded begin php"><span><?php</span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span> Guzzle http client</span><span> </span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>client</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="keyword other new php"><span>new</span></span><span> </span><span class="support other namespace php"><span class="punctuation separator inheritance php"><span>\</span></span><span>GuzzleHttp</span><span class="punctuation separator inheritance php"><span>\</span></span></span><span class="support class php"><span>Client</span></span><span>(</span><span class="punctuation section array begin php"><span>[</span></span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>'</span></span><span class="meta string-contents quoted single php"><span>base_url</span></span><span class="punctuation definition string end php"><span>'</span></span></span><span> </span><span class="keyword operator key php"><span>=></span></span><span> </span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>'</span></span><span class="meta string-contents quoted single php"><span class="markup underline link http hyperlink"><span>http://localhost</span></span></span><span class="punctuation definition string end php"><span>'</span></span></span><span class="punctuation section array end php"><span>]</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span> </span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span> Create Mock</span><span> </span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mock</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="keyword other new php"><span>new</span></span><span> </span><span class="support other namespace php"><span class="punctuation separator inheritance php"><span>\</span></span><span>GuzzleHttp</span><span class="punctuation separator inheritance php"><span>\</span></span><span>Subscriber</span><span class="punctuation separator inheritance php"><span>\</span></span></span><span class="support class php"><span>Mock</span></span><span>()</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span> </span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span> Attach mocking subscriber to the client</span><span> </span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>client</span></span><span class="keyword operator class php"><span>-></span></span><span class="meta function-call object php"><span>getEmitter</span></span><span>(</span><span>)</span><span class="keyword operator class php"><span>-></span></span><span class="meta function-call object php"><span>attach</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mock</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span> </span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span> Add response to a queue</span><span> </span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>'</span></span><span class="meta string-contents quoted single php"><span>/path/to/raw/response.txt</span></span><span class="punctuation definition string end php"><span>'</span></span></span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="support function file php"><span>file_get_contents</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mock</span></span><span class="keyword operator class php"><span>-></span></span><span class="meta function-call object php"><span>addResponse</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div></pre>
<p>The content of <code>/path/to/raw/response.txt</code> is a raw http response.</p>
<pre><code>HTTP/1.1 200 OK
Date: Wed, 15 Jun 2016 17:02:51 GMT
Server: nginx
Content-Length: 86
Content-Type: application/json; charset=utf-8

{"id":1,"active":1,"title":"Article 1","body":"Content","tags":"tags,tugs","author":1}
</code></pre><p>The next request the client makes it will pick the first response on the queue as the result.</p>
<p>You can add more responses to the queue, and make sure you the queue is not empty before you send a new request.</p>
<pre rel="php" class="editor editor-colors"><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="punctuation section embedded begin php"><span><?php</span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>'</span></span><span class="meta string-contents quoted single php"><span>/path/to/raw/http/response/file.txt</span></span><span class="punctuation definition string end php"><span>'</span></span></span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="support function file php"><span>file_get_contents</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mock</span></span><span class="keyword operator class php"><span>-></span></span><span class="meta function-call object php"><span>addResponse</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div></pre>
<h2>Guzzle HTTP 6</h2><p>On version 6 they removed the <code>Mock</code> class and introduce a new <code>MockHandler</code> class. <a href="http://docs.guzzlephp.org/en/stable/testing.html#mock-handler">docs</a>.</p>
<p>We now need to create a http client and attach the <code>MockHandler</code> object as the client handler</p>
<pre rel="php" class="editor editor-colors"><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="punctuation section embedded begin php"><span><?php</span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span> Guzzle http client</span><span> </span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>handler</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="keyword other new php"><span>new</span></span><span> </span><span class="support other namespace php"><span class="punctuation separator inheritance php"><span>\</span></span><span>GuzzleHttp</span><span class="punctuation separator inheritance php"><span>\</span></span><span>Handler</span><span class="punctuation separator inheritance php"><span>\</span></span></span><span class="support class php"><span>MockHandler</span></span><span>()</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>client</span></span><span> </span><span class="keyword operator assignment php"><span>=</span></span><span> </span><span class="keyword other new php"><span>new</span></span><span> </span><span class="support other namespace php"><span class="punctuation separator inheritance php"><span>\</span></span><span>GuzzleHttp</span><span class="punctuation separator inheritance php"><span>\</span></span></span><span class="support class php"><span>Client</span></span><span>(</span><span class="punctuation section array begin php"><span>[</span></span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>'</span></span><span class="meta string-contents quoted single php"><span>handler</span></span><span class="punctuation definition string end php"><span>'</span></span></span><span> </span><span class="keyword operator key php"><span>=></span></span><span> </span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>handler</span></span><span class="punctuation section array end php"><span>]</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div></pre>
<p>There is not way to access the handler, so you have to keep a reference somewhere.</p>
<p>Now all the response needs to be added to the mock handler using the <code>append</code> method.</p>
<pre rel="php" class="editor editor-colors"><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="punctuation section embedded begin php"><span>&lt;?php</span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span>&nbsp;Add&nbsp;response&nbsp;to&nbsp;a&nbsp;queue</span><span>&nbsp;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span>&nbsp;</span><span class="keyword operator assignment php"><span>=</span></span><span>&nbsp;</span><span class="string quoted single php"><span class="punctuation definition string begin php"><span>&#39;</span></span><span class="meta string-contents quoted single php"><span>/path/to/raw/http/response/file.txt</span></span><span class="punctuation definition string end php"><span>&#39;</span></span></span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span>&nbsp;</span><span class="keyword operator assignment php"><span>=</span></span><span>&nbsp;</span><span class="support function file php"><span>file_get_contents</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockPath</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="comment line double-slash php"><span class="punctuation definition comment php"><span>//</span></span><span>&nbsp;Convert&nbsp;the&nbsp;raw&nbsp;http&nbsp;response&nbsp;into&nbsp;a&nbsp;Response&nbsp;Object</span><span>&nbsp;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>response</span></span><span>&nbsp;</span><span class="keyword operator assignment php"><span>=</span></span><span>&nbsp;</span><span class="meta function-call php"><span class="support other namespace php"><span class="punctuation separator inheritance php"><span>\</span></span><span>GuzzleHttp</span><span class="punctuation separator inheritance php"><span>\</span></span><span>Psr7</span><span class="punctuation separator inheritance php"><span>\</span></span></span><span>parse_response</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>mockContent</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div><div class="line"><span class="text html php"><span class="meta embedded block php"><span class="source php"><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>handler</span></span><span class="keyword operator class php"><span>-&gt;</span></span><span class="meta function-call object php"><span>append</span></span><span>(</span><span class="variable other php"><span class="punctuation definition variable php"><span>$</span></span><span>response</span></span><span>)</span><span class="punctuation terminator expression php"><span>;</span></span></span></span></span></div></pre>
<p>Same as previous version each request pull the first response from the queue on each request.</p></article></section></div></main><hr><footer id="footer"><div class="container"><section><ul><li><span class="copyright">Copyright &copy; 2018</span></li><li><a href="/about" class="link-about">About</a></li><li><a href="https://twitter.com/WellingGuzman" class="link-twitter">Twitter</a></li><li><a href="https://github.com/WellingGuzman" class="link-github">GitHub</a></li></ul></section></div></footer><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-37732822-1', 'auto');
ga('send', 'pageview');</script></body></html>